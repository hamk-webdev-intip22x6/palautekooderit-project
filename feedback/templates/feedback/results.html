{% extends 'base.html' %}
{% block title %}Results{% endblock %}

{% block content %}

    <h1>Feedback Results</h1>

    <div class="selectionBox">
        <!-- Dropdown list of topics -->
        <h2>Select a Topic</h2>
        <select id="topicSelect">
            <option selected value="None">None</option>

            {% for topic in topics %}
                <option value="{{ topic.id }}">{{ topic.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="resultsBox">
        <div class="container">
            <hr>
            <div class="row">
                <div class="col" id="ratings">
                    <h3>Ratings</h3>
                    <ol>
                        <li>⭐ (<span id="ratings1">...</span>)</li>
                        <li>⭐⭐ (<span id="ratings2">...</span>)</li>
                        <li>⭐⭐⭐ (<span id="ratings3">...</span>)</li>
                        <li>⭐⭐⭐⭐ (<span id="ratings4">...</span>)</li>
                        <li>⭐⭐⭐⭐⭐ (<span id="ratings5">...</span>)</li>
                    </ol>
                </div>
                <div class="col" id="rating_graphics">
                    <h3>Rating Graphics</h3>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col" id="good_feedback">
                    <h3>Good Feedback</h3>
                </div>
                <div class="col" id="bad_feedback">
                    <h3>Bad Feedback</h3>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col" id="ideas_feedback">
                    <h3>Improvement Ideas</h3>
                </div>
                <div class="col">
                    <h3>Placeholder</h3>
                </div>
            </div>
        </div>
    </div>

    <script id="feedback-card-template" type="text/x-handlebars-template">
    <!-- We need to use the verbatim tag here to prevent Django from 
    messing with the context variable. Handlebars.js uses the same double
    curly brace syntax for variables. -->
    {% verbatim %}
        <div class="card">
            <div class="card-body">
                <blockquote class="blockquote">
                    <p>{{feedback_p}}</p>
                </blockquote>
            </div>
        </div>
    {% endverbatim %}
    </script>

    <script>
        let topicSelect = document.getElementById('topicSelect');
        let ratings = document.getElementById('ratings');
        let ratingGraphics = document.getElementById('rating_graphics');
        let goodFeedback = document.getElementById('good_feedback');
        let badFeedback = document.getElementById('bad_feedback');
        let ideasFeedback = document.getElementById('ideas_feedback');

        let defaultGoodFeedback = goodFeedback.innerHTML;
        let defaultBadFeedback = badFeedback.innerHTML;
        let defaultIdeasFeedback = ideasFeedback.innerHTML;

        let feedbackCardTemplateSource = document.getElementById('feedback-card-template').innerHTML;
        let feedbackCardTemplate = Handlebars.compile(feedbackCardTemplateSource);
        
        topicSelect.addEventListener('change', function() {
            if (this.value == "None") return;

            fetch(`/feedback/get-feedbacks/${this.value}`)
            .then(res => res.json())
            .then(feedbacks => {
                let ratingCounts = [0, 0, 0, 0, 0];

                // Clear previous feedbacks
                goodFeedback.innerHTML = defaultGoodFeedback;
                badFeedback.innerHTML = defaultBadFeedback;
                ideasFeedback.innerHTML = defaultIdeasFeedback;

                for (let i = 0; i < feedbacks.length; i++) {
                    let feedback = feedbacks[i];
                    let fields = feedback["fields"]

                    ratingCounts[fields["rating"] - 1] += 1;

                    let goodFeedbackText = fields["good"];
                    let badFeedbackText = fields["bad"];
                    let ideasFeedbackText = fields["ideas"];

                    if (goodFeedbackText != "") {
                        let goodFeedbackCardHTML = feedbackCardTemplate({ feedback_p: goodFeedbackText });
                        goodFeedback.innerHTML += goodFeedbackCardHTML;
                    }

                    if (badFeedbackText != "") {
                        let badFeedbackCardHTML = feedbackCardTemplate({ feedback_p: badFeedbackText });
                        badFeedback.innerHTML += badFeedbackCardHTML;
                    }

                    if (ideasFeedbackText != "") {
                        let ideasFeedbackCardHTML = feedbackCardTemplate({ feedback_p: ideasFeedbackText });
                        ideasFeedback.innerHTML += ideasFeedbackCardHTML;
                    }
                }

                document.getElementById('ratings1').innerHTML = ratingCounts[0];
                document.getElementById('ratings2').innerHTML = ratingCounts[1];
                document.getElementById('ratings3').innerHTML = ratingCounts[2];
                document.getElementById('ratings4').innerHTML = ratingCounts[3];
                document.getElementById('ratings5').innerHTML = ratingCounts[4];
            });
        });
    </script>

{% endblock %}