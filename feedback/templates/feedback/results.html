{% extends 'base.html' %}
{% block extrahead %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.8/handlebars.min.js" integrity="sha512-E1dSFxg+wsfJ4HKjutk/WaCzK7S2wv1POn1RRPGh8ZK+ag9l244Vqxji3r6wgz9YBf6+vhQEYJZpSjqWFPg9gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}
{% block title %}Results{% endblock %}

{% block content %}

    <h1>Feedback Results</h1>

    <div class="selectionBox">
        <!-- Dropdown list of topics -->
        <h2>Select a Topic</h2>
        <select id="topicSelect">
            <option selected value="None">None</option>

            {% for topic in topics %}
                <option value="{{ topic.id }}">{{ topic.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="resultsBox">
        <div class="container">
            <hr>
            <div class="row">
                <div class="col" id="ratings">
                    <h3>Ratings</h3>
                    <ol>
                        <li>⭐ (<span id="ratings1">0</span>)</li>
                        <li>⭐⭐ (<span id="ratings2">0</span>)</li>
                        <li>⭐⭐⭐ (<span id="ratings3">0</span>)</li>
                        <li>⭐⭐⭐⭐ (<span id="ratings4">0</span>)</li>
                        <li>⭐⭐⭐⭐⭐ (<span id="ratings5">0</span>)</li>
                    </ol>
                    <p>Average score: <span id="averageRating">0</span></p>
                </div>
                <div class="col" id="rating_graphics" style="max-height: 400px;">
                    <h3>Rating Graphics</h3>
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col">
                    <h3>Good Feedback</h3>
                    <div class="overflow-auto" id="good_feedback" style="max-height: 400px;"></div>
                </div>
                <div class="col">
                    <h3>Bad Feedback</h3>
                    <div class="overflow-auto" id="bad_feedback" style="max-height: 400px;"></div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col">
                    <h3>Feedback Ideas</h3>
                    <div class="overflow-auto" id="ideas_feedback" style="max-height: 400px;"></div>
                </div>
                <div class="col">
                    <h3>Placeholder</h3>
                </div>
            </div>
        </div>
    </div>

    <script id="feedback-card-template" type="text/x-handlebars-template">
    <!-- We need to use the verbatim tag here to prevent Django from 
    messing with the context variable. Handlebars.js uses the same double
    curly brace syntax for variables. -->
    {% verbatim %}
        <div class="card">
            <div class="card-body">
                <blockquote class="blockquote">
                    <p>{{feedback_p}}</p>
                </blockquote>
            </div>
        </div>
    {% endverbatim %}
    </script>

    <script>
        let topicSelect = document.getElementById('topicSelect');
        let ratings = document.getElementById('ratings');
        let ratingGraphics = document.getElementById('rating_graphics');
        let goodFeedback = document.getElementById('good_feedback');
        let badFeedback = document.getElementById('bad_feedback');
        let ideasFeedback = document.getElementById('ideas_feedback');

        let feedbackCardTemplateSource = document.getElementById('feedback-card-template').innerHTML;
        let feedbackCardTemplate = Handlebars.compile(feedbackCardTemplateSource);

        let ratingChart;
        
        topicSelect.addEventListener('change', function() {
            if (this.value == "None") return;

            fetch(`/feedback/get-feedbacks/${this.value}`)
            .then(res => res.json())
            .then(feedbacks => {
                let ratingCounts = [0, 0, 0, 0, 0];

                // Clear previous feedbacks
                goodFeedback.innerHTML = "";
                badFeedback.innerHTML = "";
                ideasFeedback.innerHTML = "";

                for (let i = 0; i < feedbacks.length; i++) {
                    let feedback = feedbacks[i];
                    let fields = feedback["fields"]

                    ratingCounts[fields["rating"] - 1] += 1;

                    let goodFeedbackText = fields["good"];
                    let badFeedbackText = fields["bad"];
                    let ideasFeedbackText = fields["ideas"];

                    if (goodFeedbackText != "") {
                        let goodFeedbackCardHTML = feedbackCardTemplate({ feedback_p: goodFeedbackText });
                        goodFeedback.innerHTML += goodFeedbackCardHTML;
                    }

                    if (badFeedbackText != "") {
                        let badFeedbackCardHTML = feedbackCardTemplate({ feedback_p: badFeedbackText });
                        badFeedback.innerHTML += badFeedbackCardHTML;
                    }

                    if (ideasFeedbackText != "") {
                        let ideasFeedbackCardHTML = feedbackCardTemplate({ feedback_p: ideasFeedbackText });
                        ideasFeedback.innerHTML += ideasFeedbackCardHTML;
                    }
                }

                document.getElementById('ratings1').innerHTML = ratingCounts[0];
                document.getElementById('ratings2').innerHTML = ratingCounts[1];
                document.getElementById('ratings3').innerHTML = ratingCounts[2];
                document.getElementById('ratings4').innerHTML = ratingCounts[3];
                document.getElementById('ratings5').innerHTML = ratingCounts[4];

                // Calculate average rating
                let total = 0;
                let count = 0;
                for (let i = 0; i < ratingCounts.length; i++) {
                    total += (i + 1) * ratingCounts[i];
                    count += ratingCounts[i];
                }

                let averageRating = total / count;
                document.getElementById('averageRating').innerHTML = averageRating.toFixed(2);

                // Update rating chart
                if (ratingChart) {
                    ratingChart.destroy();
                }

                ratingChart = new Chart(document.getElementById("ratingChart"),
                {
                    type: "bar",
                    data: {
                        labels: ["⭐", "⭐⭐", "⭐⭐⭐", "⭐⭐⭐⭐", "⭐⭐⭐⭐⭐"],
                        datasets: [
                            {
                                label: "Amount of Ratings",
                                data: ratingCounts
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: {
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            });
        });
    </script>

{% endblock %}